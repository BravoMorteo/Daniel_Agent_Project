<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HeyGen + ElevenLabs con LiveKit (P√∫blico)</title>
    <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f0f0;
        }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        #startBtn { background: #4CAF50; color: white; }
        #startBtn:disabled { background: #cccccc; }
        #stopBtn { background: #f44336; color: white; }
        video {
            width: 100%;
            max-height: 500px;
            background: white;
            border-radius: 10px;
            display: block;
            min-height: 400px;
        }
        #status {
            background: #333;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .transcription {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            min-height: 100px;
        }
        .url-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üé¨ HeyGen Avatar + ElevenLabs IA</h1>
    <p><strong>LiveKit Integration (Versi√≥n P√∫blica)</strong></p>
    
    <div class="url-info">
        <strong>üåê Conectando a:</strong> <span id="urlInfo">Detectando...</span>
    </div>
    
    <div class="controls">
        <button id="startBtn">‚ñ∂Ô∏è Iniciar Conversaci√≥n</button>
        <button id="stopBtn">‚èπÔ∏è Detener</button>
        <button id="debugBtn" style="background: #ff9800;">üîç Debug Video</button>
    </div>

    <video id="videoElement" autoplay playsinline muted></video>

    <div class="transcription">
        <h3>üí¨ Transcripciones</h3>
        <div id="transcription"></div>
    </div>

    <div id="status"></div>

    <script>
        // Detectar URL autom√°ticamente
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/hybrid`;
        
        document.getElementById('urlInfo').textContent = wsUrl;
        
        // Configuraci√≥n
        let sessionInfo = null;
        let room = null;
        let mediaStream = null;
        let ws_client = null;
        let ws_elevenlabs = null;

        const videoElement = document.getElementById('videoElement');
        const statusElement = document.getElementById('status');
        const transcriptionElement = document.getElementById('transcription');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');

        // Eventos del video element para debugging
        videoElement.addEventListener('loadstart', () => log('üé¨ Video: loadstart'));
        videoElement.addEventListener('loadedmetadata', () => log('üìä Video: metadata cargada'));
        videoElement.addEventListener('loadeddata', () => log('üì¶ Video: data cargada'));
        videoElement.addEventListener('canplay', () => log('‚ñ∂Ô∏è Video: can play'));
        videoElement.addEventListener('canplaythrough', () => log('‚è© Video: can play through'));
        videoElement.addEventListener('playing', () => log('üé• Video: REPRODUCIENDO'));
        videoElement.addEventListener('error', (e) => {
            log(`‚ùå Video ERROR: ${e.message || 'Unknown error'}`);
            if (videoElement.error) {
                log(`   Code: ${videoElement.error.code}, Message: ${videoElement.error.message}`);
            }
        });
        videoElement.addEventListener('stalled', () => log('‚è∏Ô∏è Video: stalled'));
        videoElement.addEventListener('waiting', () => log('‚è≥ Video: waiting'));

        function log(msg) {
            const time = new Date().toLocaleTimeString();
            statusElement.innerHTML += `[${time}] ${msg}<br>`;
            statusElement.scrollTop = statusElement.scrollHeight;
            console.log(msg);
        }

        function addTranscription(text, type = 'user') {
            const color = type === 'user' ? '#0066cc' : '#cc0000';
            const prefix = type === 'user' ? 'üë§ T√∫' : 'ü§ñ IA';
            transcriptionElement.innerHTML += `<p style="color:${color}"><strong>${prefix}:</strong> ${text}</p>`;
        }

        async function startConversation() {
            try {
                startBtn.disabled = true;
                log('üöÄ Iniciando conversaci√≥n...');
                log(`üîó Conectando a: ${wsUrl}`);

                // Conectar al servidor WebSocket (auto-detecta localhost o ngrok)
                ws_client = new WebSocket(wsUrl);
                
                ws_client.onopen = () => {
                    log('‚úÖ Conectado al servidor');
                };

                ws_client.onmessage = async (event) => {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'avatar_ready') {
                        log(`‚úÖ Avatar creado: ${data.session_id}`);
                        sessionInfo = data;
                        
                        // Iniciar LiveKit
                        await setupLiveKit();
                        
                        // Notificar al servidor
                        ws_client.send(JSON.stringify({ type: 'client_ready' }));
                    }
                    else if (data.type === 'elevenlabs_connected') {
                        log('‚úÖ ElevenLabs conectado');
                        // Iniciar captura de micr√≥fono
                        await startMicrophone();
                    }
                    else if (data.type === 'user_transcript') {
                        addTranscription(data.text, 'user');
                    }
                    else if (data.type === 'agent_response') {
                        addTranscription(data.text, 'agent');
                    }
                };

                ws_client.onerror = (error) => {
                    log(`‚ùå Error WebSocket: ${error}`);
                };

                ws_client.onclose = () => {
                    log('üî¥ Conexi√≥n cerrada');
                    startBtn.disabled = false;
                };

            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
                startBtn.disabled = false;
            }
        }

        async function setupLiveKit() {
            try {
                log('üîó Configurando LiveKit...');
                
                // Crear LiveKit Room
                room = new LivekitClient.Room({
                    adaptiveStream: true,
                    dynacast: true,
                    videoCaptureDefaults: {
                        resolution: LivekitClient.VideoPresets.h720.resolution
                    }
                });

                // Manejar PARTICIPANTES remotos (no tracks individuales)
                room.on(LivekitClient.RoomEvent.TrackSubscribed, (track, publication, participant) => {
                    log(`üì∫ Track recibido de ${participant.identity}: ${track.kind}`);
                    
                    if (track.kind === 'video') {
                        // Attach retorna un elemento <video> completo ya configurado
                        const element = track.attach();
                        
                        // Log de diagn√≥stico
                        log(`üîç Video creado: readyState=${element.readyState}`);
                        log(`üîç srcObject: ${element.srcObject ? 'OK' : 'NULL'}`);
                        if (element.srcObject) {
                            const tracks = element.srcObject.getTracks();
                            log(`üîç Tracks: ${tracks.length} (${tracks.map(t => t.kind).join(', ')})`);
                        }
                        
                        // Configurar propiedades
                        element.autoplay = true;
                        element.playsInline = true;
                        element.muted = false;
                        element.style.display = 'block';
                        element.style.width = '100%';
                        element.style.height = '100%';
                        element.style.objectFit = 'cover';
                        element.style.backgroundColor = '#fff';
                        
                        // Eventos de diagn√≥stico
                        element.addEventListener('loadstart', () => {
                            log(`üé¨ Video: loadstart (readyState=${element.readyState})`);
                        });
                        element.addEventListener('loadedmetadata', () => {
                            log(`üìê Metadata cargada: ${element.videoWidth}x${element.videoHeight}`);
                        });
                        element.addEventListener('canplay', () => {
                            log('‚úÖ Video: canplay - intentando play...');
                            element.play().catch(e => log(`‚ùå Play fall√≥: ${e.message}`));
                        });
                        element.addEventListener('playing', () => {
                            log('‚ñ∂Ô∏è Video: PLAYING!');
                        });
                        element.addEventListener('waiting', () => log('‚è≥ Video: waiting'));
                        element.addEventListener('stalled', () => log('‚ö†Ô∏è Video: stalled'));
                        element.addEventListener('suspend', () => log('‚è∏Ô∏è Video: suspend'));
                        element.addEventListener('error', (e) => {
                            log(`‚ùå Video error: ${e.target.error?.message || 'unknown'}`);
                        });
                        
                        // REEMPLAZAR el elemento completo en el DOM
                        const oldElement = document.getElementById('videoElement');
                        if (oldElement) {
                            oldElement.replaceWith(element);
                            element.id = 'videoElement';
                            videoElement = element;
                            log(`‚úÖ Video element REEMPLAZADO en DOM`);
                        }
                        
                        // Forzar reproducci√≥n
                        setTimeout(() => {
                            log(`üîÑ Forzando play... readyState=${element.readyState}`);
                            element.play().then(() => {
                                log('‚úÖ Play forzado exitoso');
                            }).catch(e => {
                                log(`‚ö†Ô∏è Play forzado fall√≥: ${e.message}`);
                            });
                        }, 500);
                    }
                    
                    if (track.kind === 'audio') {
                        // Para audio, attach directo (no usar el videoElement para audio)
                        const audioElement = track.attach();
                        audioElement.autoplay = true;
                        document.body.appendChild(audioElement);
                        log(`üîä Audio reproduciendo desde ${participant.identity}`);
                    }
                });

                room.on(LivekitClient.RoomEvent.TrackUnsubscribed, (track, publication, participant) => {
                    log(`üî¥ Track removido de ${participant.identity}: ${track.kind}`);
                    track.detach();
                });

                room.on(LivekitClient.RoomEvent.Disconnected, (reason) => {
                    log(`üî¥ LiveKit desconectado: ${reason}`);
                });

                // Manejar participantes que ya est√°n en la sala
                room.on(LivekitClient.RoomEvent.ParticipantConnected, (participant) => {
                    log(`üë• Participante conectado: ${participant.identity}`);
                });

                // Detectar errores de media
                room.on(LivekitClient.RoomEvent.MediaDevicesError, (error) => {
                    log(`‚ùå Error de dispositivos: ${error}`);
                });

                room.on(LivekitClient.RoomEvent.ConnectionQualityChanged, (quality, participant) => {
                    log(`üì∂ Calidad conexi√≥n: ${quality}`);
                });

                // Conectar a LiveKit
                await room.connect(sessionInfo.url, sessionInfo.access_token);
                log('‚úÖ Conectado a LiveKit Room');
                
                // Procesar participantes existentes (avatar ya en la sala)
                room.participants.forEach((participant) => {
                    log(`üë• Procesando participante existente: ${participant.identity}`);
                    participant.trackPublications.forEach((publication) => {
                        if (publication.isSubscribed && publication.track) {
                            log(`üì∫ Track existente: ${publication.track.kind}`);
                            
                            if (publication.track.kind === 'video') {
                                const tempElement = publication.track.attach();
                                if (tempElement.srcObject) {
                                    videoElement.srcObject = tempElement.srcObject;
                                    videoElement.muted = false;
                                    videoElement.play().then(() => {
                                        log(`‚úÖ Video reproduciendo (participante existente)`);
                                        videoElement.style.display = 'block';
                                    }).catch(e => {
                                        log(`‚ö†Ô∏è Error play: ${e.message}`);
                                    });
                                }
                            }
                            
                            if (publication.track.kind === 'audio') {
                                const audioElement = publication.track.attach();
                                audioElement.autoplay = true;
                                document.body.appendChild(audioElement);
                                log(`üîä Audio configurado (participante existente)`);
                            }
                        }
                    });
                });

            } catch (error) {
                log(`‚ùå Error LiveKit: ${error.message}`);
            }
        }

        async function startMicrophone() {
            try {
                log('üé§ Solicitando micr√≥fono...');
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 16000
                    }
                });
                
                log('‚úÖ Micr√≥fono capturado');
                
                // Crear procesador de audio
                const audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 16000
                });
                const source = audioContext.createMediaStreamSource(stream);
                const processor = audioContext.createScriptProcessor(4096, 1, 1);

                source.connect(processor);
                processor.connect(audioContext.destination);

                processor.onaudioprocess = (e) => {
                    if (ws_client && ws_client.readyState === WebSocket.OPEN) {
                        const inputData = e.inputBuffer.getChannelData(0);
                        
                        // Convertir a PCM16
                        const pcm16 = new Int16Array(inputData.length);
                        for (let i = 0; i < inputData.length; i++) {
                            const s = Math.max(-1, Math.min(1, inputData[i]));
                            pcm16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                        }
                        
                        // Enviar al servidor
                        ws_client.send(pcm16.buffer);
                    }
                };

                log('üéôÔ∏è Captura de audio activa');
                
            } catch (error) {
                log(`‚ùå Error de micr√≥fono: ${error.message}`);
            }
        }

        async function stopConversation() {
            log('‚èπÔ∏è Deteniendo conversaci√≥n...');
            
            if (room) {
                room.disconnect();
                room = null;
            }
            
            if (ws_client) {
                ws_client.close();
                ws_client = null;
            }
            
            if (videoElement.srcObject) {
                videoElement.srcObject.getTracks().forEach(track => track.stop());
                videoElement.srcObject = null;
            }
            
            sessionInfo = null;
            mediaStream = null;
            startBtn.disabled = false;
            
            log('‚úÖ Conversaci√≥n detenida');
        }

        // Event listeners
        startBtn.addEventListener('click', startConversation);
        stopBtn.addEventListener('click', stopConversation);
        
        document.getElementById('debugBtn').addEventListener('click', () => {
            log('üîç DEBUG INFO:');
            log(`- Video element: ${videoElement ? 'exists' : 'missing'}`);
            log(`- srcObject: ${videoElement.srcObject ? 'assigned' : 'null'}`);
            log(`- readyState: ${videoElement.readyState}`);
            log(`- paused: ${videoElement.paused}`);
            log(`- muted: ${videoElement.muted}`);
            if (mediaStream) {
                log(`- Video tracks: ${mediaStream.getVideoTracks().length}`);
                log(`- Audio tracks: ${mediaStream.getAudioTracks().length}`);
                mediaStream.getVideoTracks().forEach((track, i) => {
                    log(`  Track ${i}: ${track.label} - enabled: ${track.enabled} - readyState: ${track.readyState}`);
                });
            }
            
            // Intentar forzar play
            videoElement.play().then(() => {
                log('‚úÖ Video play() exitoso');
            }).catch(e => {
                log(`‚ùå Video play() fall√≥: ${e.message}`);
            });
        });

        log('‚úÖ Listo para comenzar');
        log(`üåê Modo: ${isLocalhost ? 'LOCALHOST' : 'P√öBLICO (ngrok/internet)'}`);
    </script>
</body>
</html>
